% !TeX root = ../main-conf.tex
\section{Graph rewriting}

We have now shown that we can reason up to the axioms of symmetric traced
categories with a comonoid structure computationally using hypergraphs: two
string diagrams equal by topological deformations are translated into isomorphic
hypergraphs.
However, to reason about an \emph{monoidal theory} with extra equations we must
actually rewrite the components of the graph.
This is possible with \emph{graph rewriting}.

A common framework is that of \emph{double pushout rewriting} (DPO rewriting).
We use an extension, known as \emph{double pushout rewriting with interfaces},
(DPOI rewriting).

\begin{definition}[Rewrite rule]
    Given interfaced hypergraphs \(
        \cospan{i}[a_1]{L}[a_2]{j}
    \) and \(
        \cospan{i}[b_1]{R}[b_2]{j}
    \), their rewrite rule is a span in \(\hypsigma\): \(
        \spann{L}[[a_1,a_2]]{i+j}[[b_1,b_2]]{R}
    \).
\end{definition}

\begin{definition}[DPO(I) rewriting]\label{def:dpo}
    For morphisms \(G \leftarrow m+n\) and \(H \leftarrow m+n\) in
    \(\hypsigma\), there is a rewrite \(G \trgrewrite[\mcr] H\) if there
    exists a rule \(
        \spann{L}{i+j}{G} \in \mcr
    \) and cospan \(
        \cospan{i+j}{C}{n+m} \in \hypsigma
    \) such that diagram below commutes:
    \begin{center}
        \includestandalone{figures/graphs/dpo/dpo}
    \end{center}
\end{definition}

In order to apply a given rewrite rule \(\spann{L}{i+j}{R}\) in some larger
graph \(\cospan{m}{G}{n}\), a morphism \(L \to G\) must first be identified.
The next step is to `cut out' the components of \(L\) which exist in \(G\).

\begin{definition}[Pushout complement]\label{def:pushout-complement}
    Given morphisms \(i + j \to L \to G \rightarrow m + n\) be morphisms in
    \(\hypsigma\).
    Then the \emph{pushout complement} of these morphisms is an object \(C\)
    with morphisms \(i + j \to C \to G\) such that \(\cospan{L}{G}{C}\) is a
    pushout and the following diagram commutes:
    \begin{center}
        \includestandalone{figures/graphs/dpo/pushout-complement}
    \end{center}
\end{definition}

Once a pushout complement \(C\) is computed, the pushout of
\(\spann{C}{i+j}{R}\) can be computed to compute the completed rewrite \(H\).
However, a pushout complement may not exist for a given rule and matching.

\begin{definition}[\cite{bonchi2022string}, Definition 3.16]
    Let \(i + j \xrightarrow{a} L \xrightarrow{f} G\) be morphisms in
    \(\hypsigma\).

    The morphisms satisfy the \emph{no-dangling} condition if, for every
    hyperedge not in the image of \(f\), each of its source and target vertices
    is either not in the image of \(m\) or in the image of \(i \seq m\).

    The morphisms satisfy the \emph{no-identification} condition if, for any two
    distinct vertices \(v_1\) and \(v_2\) such that \(m(v_1) = m(v_2)\), \(v_1\)
    and \(v_2\) are in the image of \(i\).
\end{definition}

\begin{proposition}[\cite{bonchi2022string}, Proposition 3.17]
    \label{prop:pushout-complement}
    The morphisms \(i + j \to L \to G\) have at least one pushout complement if
    and only if they satisfies the no-dangling and no-identification conditions.
\end{proposition}

\begin{definition}
    Given a partial monogamous cospan \(\cospan{i}{L}{j}\), a morphism
    \(L \to G\) is called a \emph{matching} if it has at least one pushout
    complement.
\end{definition}

In certain settings, known as
\emph{adhesive categories}~\cite{lack2004adhesive}, it is possible to be more
precise about the number of pushout complements for a given matching and rewrite
rule.

\begin{proposition}[\cite{lack2004adhesive}]
    In an adhesive category, pushout complements of \(
        i + j \xrightarrow{a} L \to G\)
    are unique if they exist and \(a\) is mono.
\end{proposition}

\begin{proposition}[\cite{lack2005adhesive}]
    \(\hypsigma\) is adhesive.
\end{proposition}

Since a given pushout complement uniquely determines the rewrite performed, it
might seem advantageous to always have exactly one pushout complement.
However, as shall be detailed later, when writing modulo traced comonoid
structure, there are settings where having multiple pushout complements is
beneficial.

\subsection{Rewriting with traced structure}

While in the Frobenius case considered in~\cite{bonchi2022string}, all valid
pushout complements correspond to a valid rewrite, this is not the case for the
traced monoidal case: for example, a wire cannot connect the outputs of two
boxes together.
In \cite{bonchi2021string}, pushout complements that correspond to a valid
rewrite in the non-traced symmetric monoidal case are identified as
\emph{boundary complements}.
We will use a weakening of this definition.

\begin{definition}[Traced boundary complement]
    \label{def:traced-boundary-complement}
    For partial monogamous cospans \(
        \cospan{i}[a_1]{L}[a_2]{j}
    \) and \(
        \cospan{n}[b_1]{G}[b_2]{m} \in \mathcal{C}
    \), and traced candidate \(
        \morph{f}{L}{G} \in \hypsigma
    \), a pushout complement as in \cref{def:pushout-complement} is called a
    \emph{traced boundary complement} if \(c_1\) and \(c_2\) are mono and \(
        \cospan{j+m}[[c_2,d_1]]{\pushoutcomplement{L}}[[d_2,c_1]]{{n+i}}
    \) is a partial monogamous cospan.
\end{definition}

Unlike~\cite{bonchi2021string}, we do not enforce that the matching is mono,
as restricting to these matchings actually cuts off potential rewrites in the
\emph{traced} setting, such as the occurrence of a rewrite rule inside a loop:
\begin{center}
    \iltikzfig{graphs/dpo/matchings/non-mono-matching}
\end{center}

However, there may be matchings for which the pushout complement is a traced
boundary complement but do not correspond to a valid rewrite.
This can arise when the morphism merges edges.
We must restrict morphisms such that only the vertices in the interfaces can be
merged to create loops.
In the interests of consistency, we borrow terminology
from~\cite{milosavljevic2022string}.

\begin{definition}[Offcut matching]
    Given partial monogamous cospans \(\cospan{i}[a_1]{L}[a_2]{j}\) and
    \(\cospan{m}{G}{n}\), a matching \(\morph{f}{L}{G}\) is called a
    \emph{traced rewrite candidate} if is injective on edges and vertices not
    in the image of \([a_1,a_2]\).
\end{definition}

\begin{definition}[Traced DPO]
    For morphisms \(G \leftarrow m+n\) and \(H \leftarrow m+n\) in
    \(\hypsigma\), there is a traced rewrite \(G \trgrewrite[\mcr] H\) if there
    exists a rule \(
        \spann{L}{i+j}{G} \in \mcr
    \) and cospan \(
        \cospan{i+j}{C}{n+m} \in \hypsigma
    \) such that diagram in \cref{def:dpo} commutes, \(i+j \to C\) is a
    traced boundary complement and \(\morph{f}{L}{G}\) is an offcut matching.
\end{definition}

Some intuition regarding the construction of traced boundary complements may be
required.
This will be provided by a series of lemmas:

\begin{lemma}
    \label{lem:merged-in-traced-complement}
    In a traced boundary complement, if \(
        a_1(v) = a_2(w)
    \), then \(
        c_1(v) = c_2(w)
    \) if and only if \(f(a_1(v) = f(c_2(w)))\) has degree \((0, 0)\) and is
    not in the image of \(b\).
\end{lemma}
\iftoggle{proofs}{
    \begin{proof}
        For the \(\onlyifdir\) direction, assume that \(c_1(v) = c_2(w)\): let this
        vertex be \(v^\prime\).
        Since (\ref{gat:traced-complement}) is partial monogamous, \([c_2,d_1]\) and
        \([c_1,d_2]\) must be mono, and thus the images of \(c_1\) and \(d_2\) must
        be disjoint, as must the images of \(c_2\) and \(d_1\).
        Therefore \(v^\prime\) cannot be in the image of \(d\); moreover, \(c_1(v)\)
        must have out-degree \(0\) and \(c_2(w)\) must have in-degree \(0\), so
        \(v^\prime\) has degree \((0,0)\).
        Let \(v^{\prime\prime}\) be \(a_1(v) = a_2(w)\): since \(
            \cospan{i}[a_1]{\iltikzfig{strings/rewriting/l}}[a_2]{j}
        \) is a partial monogamous cospan \(v^\prime\) must have degree \((0,0)\).
        Since \(G\) is computed by pushout, \(
            f(v^{\prime\prime}) = g(v^{\prime})
        \) and the degree of this vertex is contributed wholly by \(v^\prime\) and
        \(v^{\prime\prime}\).
        So \(f(a_1(v)) = f(a_2(w))\) also has degree \((0,0)\).

        Now for the \(\ifdir\) direction, assume that \(c_1(v)\) and \(c_2(w)\)
        are not in the image of \(d\), and \(f(a_1(v)) = f(a_2(w))\) has degree
        \((0,0)\).
        Assume that \(c_1(v) \neq c_2(w)\).
        By semi-monogamy of (\ref{gat:traced-complement}), \(c_1(v)\) must have
        degree \((0,1)\) since it is solely in the image of \([d_2, c_1]\).
        But \(f(a_1(v)) = f(a_2(w)) = g(c_1(v)) = g(c_2(w))\), \(c_1(v)\) and
        \(c_2(w)\) must have degree \((0,0)\), a contradiction.
        The same holds for \(c_2(w)\), so \(c_1(v) = c_2(w)\).
    \end{proof}
}{}

Effectively, this means that is vertices are merged by \(a\), the rewrite rule
is looking for \emph{identities} into which one or more edges will be inserted.
This means that for the most part these vertices must be broken apart in the
pushout complement in order to make room for the new edges.
The only time they \emph{cannot} be broken apart is if the matching is into
a closed loop: a vertex with degree \((0, 0)\) that is not in the image of
\(b\).
If this vertex were to be broken apart in the pushout complement, then this
data about the closed loop would be lost.

Loops can also be created when vertices that are not merged in \(L\) are merged
by the matching \(f\).
This data must also be captured by the pushout complement.

\begin{lemma}
    In a traced boundary complement, if \(a_1(v) \neq a_2(w)\) but \(
        f(a_1(v)) = f(a_2(w))
    \), and the degree of \(a_1(v)\) and \(a_2(w)\) is not \((0,0)\), then
    \(c_1(v) = c_2(w)\).
\end{lemma}
\iftoggle{proofs}{
    \begin{proof}
        Since the diagram is a pushout, if \(a_1(v) \neq a_2(w)\) but \(
            f(a_1(v)) = f(a_2(w))
        \) then vertices must be merged \(c\) to force the latter to the equal.
        Since \(a_1(v)\) and \(a_2(w)\) do not have degree \((0,0)\), they
        have not been merged by \(a\) by partial monogamicity, so there is only
        one choice of map for \([c_1, c_2]\): to merge the vertices together.
    \end{proof}
}{}

The merging of vertices by \(f\) with degree \((0, 0)\) is an important edge
case, as it corresponds to rewriting modulo the \emph{yanking} axiom of traced
categories.
It is this case that yields a \emph{choice} of traced boundary complement,
which unlike regular boundary complements need not be unique.

\begin{example}
    Consider the rule and its interpretation.
    \begin{gather}
        \rrule{
            \iltikzfig{graphs/dpo/non-unique/rule-lhs}
        }{
            \iltikzfig{graphs/dpo/non-unique/rule-rhs}
        }
        \qquad
        \raisebox{-2.1em}{\includestandalone{figures/graphs/dpo/non-unique/rule}}
        \label{gath:non-unique-rule}
    \end{gather}

    Now consider the following hypergraph with interface \(
        \iltikzfig{graphs/dpo/non-unique/g-unlabelled}
        \leftarrow
        \iltikzfig{graphs/dpo/non-unique/j-unlabelled}
    \).
    There are \emph{two} valid traced boundary complements for the above rule in
    this graph!

    \begin{center}
        \includestandalone{figures/graphs/dpo/non-unique/rewrite-1}
        \includestandalone{figures/graphs/dpo/non-unique/rewrite-2}
    \end{center}

    Both derivations are valid and arise since we are rewriting modulo
    \emph{yanking}:
    \begin{gather*}
        \iltikzfig{graphs/dpo/non-unique/derivation-1}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-2}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-3a}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-4a}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-5a}
        \\
        \iltikzfig{graphs/dpo/non-unique/derivation-1}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-2}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-3b}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-4b}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-5b}
    \end{gather*}
\end{example}

When vertices are merged in this way, the choice of traced boundary complement
dictates the position on the yanked wires to apply the rewrite.
Although there are multiple to choose from, there are still properties enforced
by partial monogamy.

\begin{lemma}
    In a traced boundary complement, let \(v \in i\) and
    \(w_0, w_1, \cdots w_k\) such that \(f(a_1(v)) = f(a_2(w_0))\),
    \(f(a_1(v)) = f(a_2(w_1))\) and so on.
    Then either (1) there exists exactly one \(w_l\) such that
    \(c_1(v) = c_2(w_l)\); (2) \(c_1(v)\) is in the image of \(d_1\); or (3)
    \(c_1(v)\) has degree \((1,0)\).

    The same also holds for \(w \in j\), with the interface map as \(d_2\) and
    the degree as \((0,1)\).
\end{lemma}
\iftoggle{proofs}{
    \begin{proof}
        Since \(c_1(v)\) is in the image of \(c\), it must have either degree
        \((0,0)\) or \((1,0)\) by partial monogamy.
        For it to have degree \((0, 0)\), it must either be in the image of one
        of \(c_2\) or \(d_2\).
        In the case of the former, this means that there must be a \(w_l\) such
        that \(c_1(v) = c_2(w_l)\), and only one such vertex as \(c_2\) is mono,
        so (1) is satisfied.
        In the case of the latter, (2) is immediately satisfied.
        Otherwise, (3) is satisfied.

        The proof for the flipped case is exactly the same.
    \end{proof}
}{}

Rewriting modulo yanking also eliminates another foible of rewriting modulo
(non-traced) symmetric monoidal structure.
In the latter, matchings must be \emph{convex}: there cannot be a path from the
outputs of a match back to its inputs.
However, in the traced case this is not necessary, as this example from
\cite{bonchi2021string} will show.

\begin{example}
    Consider the following rewrite rule and its interpretation.
    %
    \begin{gather}
        \rrule{
            \iltikzfig{graphs/dpo/convex/example-l}
        }{
            \iltikzfig{graphs/dpo/convex/example-r}
        }
        \qquad
        \iltikzfig{graphs/dpo/convex/example-rule-graph}
        \label{gath:convex-rule}
    \end{gather}
    %
    Now consider the following term and interpretation:
    %
    \begin{gather}
        \iltikzfig{graphs/dpo/convex/example-g}
        \qquad
        \iltikzfig{graphs/dpo/convex/example-g-graph}
        \label{gath:convex-term}
    \end{gather}
    Although it is not obvious in the original string diagram, there is in fact
    a matching of (\ref{gath:convex-rule}) in (\ref{gath:convex-term}).
    Performing the DPO procedure yields the following:
    %
    \begin{gather}
        \iltikzfig{graphs/dpo/convex/example-h-graph}
        \qquad
        \iltikzfig{graphs/dpo/convex/example-h}
    \end{gather}
    In a non-traced setting this is an invalid rule!
    However, it is possible with yanking.
    \begin{gather*}
        \iltikzfig{graphs/dpo/convex/example-g}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-2}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-4}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-5}
        =
        \iltikzfig{graphs/dpo/convex/example-h}
    \end{gather*}
\end{example}

We are almost ready to show the soundness and completeness of this DPO rewriting
system.
The final prerequisite is a decomposition lemma, akin to a similar result
in~\cite{bonchi2022string} for the symmetric monoidal case.

\begin{lemma}[Traced decomposition]\label{lem:traced-decomposition}
    Given partial monogamous cospans \(\cospan{m}[p_1]{G}[p_2]{n}\) and \(
        \cospan{i}[a_1]{L}[a_2]{j}
    \), along with a morphism \(
        L \xrightarrow{f} G
    \) such that \(i+j \rightarrow L \rightarrow G\) satisfies the no-dangling
    and no-identification condition, then \(
        \cospan{m}[p_1]{G}[p_2]{n}
    \) can be factored as
    \begin{gather}
        \trace{i}{
            \begin{array}{cc}
                \cospan{i}[a_1]{L}[a_2]{j} \\
                \tensor \\
                \cospan{m}{m}{m}
            \end{array}
            \seq
            \cospan{j+m}{C}{i+n}
        }
        \label{gath:decomposition}
    \end{gather}
    where all cospans are partial monogamous and \(C\) is a traced boundary
    complement.
\end{lemma}
\iftoggle{proofs}{
    \begin{proof}
        Let \(C\) be defined as a traced boundary complement of \(
            i+j \xrightarrow{[a_1,a_2]} L \xrightarrow{f} G
        \), which exists as the no-dangling and no-identification condition is
        satisfied.
        We assign names to the various cospans in play, and reason string
        diagrammatically:
        \begin{align*}
            \iltikzfig{graphs/dpo/lhat} &:= \cospan{i}{L}{j}
            &
            \iltikzfig{graphs/dpo/ltilde} &:= \cospan{0}{L}{i+j} \\
            \iltikzfig{graphs/dpo/chat} &:= \cospan{j+m}{L}{i+n}
            &
            \iltikzfig{graphs/dpo/ctilde} &:= \cospan{i+j}{C}{m+n} \\
            \iltikzfig{graphs/dpo/ghat} &:= \cospan{m}{G}{n}
            &
            \iltikzfig{graphs/dpo/gtilde} &:= \cospan{0}{G}{m+n}
        \end{align*}
        By using the compact closed structure of \(\cspfihyp\), we also have that \(
            \iltikzfig{graphs/dpo/ltilde} = \iltikzfig{graphs/dpo/lhat-bent}
        \), \(
            \iltikzfig{graphs/dpo/ctilde} = \iltikzfig{graphs/dpo/chat-bent}
        \) and \(
            \iltikzfig{graphs/dpo/gtilde} = \iltikzfig{graphs/dpo/ghat-bent}
        \).
        Since \(
            \iltikzfig{graphs/dpo/gtilde} = \iltikzfig{graphs/dpo/lctilde}
        \), it follows that \(
            \iltikzfig{graphs/dpo/ghat-bent} = \iltikzfig{graphs/dpo/lchat-bent}
        \) and subsequently \(
            \iltikzfig{graphs/dpo/ghat} = \iltikzfig{graphs/dpo/lchat}
        \).
        The `loop' is constructed in the same manner as the canonical trace on
        \(\cspfihyp\), so this is a term in the form of (\ref{gath:decomposition}).
        Moreover, all cospans involved are partial monogamous by definition of
        rewrite rules and traced boundary complements.
    \end{proof}
}{}

\begin{theorem}\label{thm:traced-rewriting}
    Let \(\mcr\) be a rewriting system on \(\stmcsigma\).
    Then, \(
        \iltikzfig{strings/category/f}[g][white]
        \rewrite[\mcr]
        \iltikzfig{strings/category/f}[H][white]
    \) if and only if \(
        \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[g][white]]]
        \grewrite[\termandfrobtohypsigma[\foldinterfaces[\mcr]]]
        \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[H][white]]].
    \)
\end{theorem}
% \iftoggle{proofs}{
    \begin{proof}
        First the \((\Rightarrow)\) direction.
        If \(
            \iltikzfig{strings/category/f}[g][white]
            \rewrite[\mcr]
            \iltikzfig{strings/category/f}[H][white]
        \) then we have \(
            \iltikzfig{strings/category/f}[g][white]
            =
            \iltikzfig{strings/rewriting/rewrite-l}
        \) and \(
            \iltikzfig{strings/rewriting/rewrite-r}
            =
            \iltikzfig{strings/category/f}[H][white].
        \)
        Define the following cospans:
        \begin{align}
            \label{gath:l-cospan}
            \cospan{0}{L}{i+j}
            &:=
            \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[l][white]]]
            &&=
            \termandfrobtohypsigma[\iltikzfig{strings/rewriting/l-folded}]
            \\
            \cospan{0}{R}{i+j}
            &:=
            \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[r][white]]]
            &&=
            \termandfrobtohypsigma[\iltikzfig{strings/rewriting/r-folded}]
            \\
            \cospan{0}{G}{m+n}
            &:=
            \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[f][white]]]
            &&=
            \termandfrobtohypsigma[\iltikzfig{strings/rewriting/lc-folded}]
            \\
            \label{gath:h-cospan}
            \cospan{0}{H}{m+n}
            &:=
            \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[H][white]]]
            &&=
            \termandfrobtohypsigma[\iltikzfig{strings/rewriting/rc-folded}]
            \\
            \cospan{i+j}{C}{m+n}
            &:=
            \termandfrobtohypsigma[\iltikzfig{strings/rewriting/c-folded}]
            &&
        \end{align}
        By functoriality, since \(
            \foldinterfaces[\iltikzfig{strings/category/f}[f][white]]
            =
            \iltikzfig{strings/rewriting/l-folded}
            \seq
            \iltikzfig{strings/rewriting/c-folded}
        \) then \[
            \cospan{0}{G}{m+n} = \cospan{0}{L}{i+j} \seq \cospan{i+j}{C}{m+n}.
        \]
        Cospan composition is pushout, so \(\cospan{L}{G}{C}\) is a pushout.
        Using the same reasoning, \(\cospan{R}{G}{C}\) is also a pushout: this
        gives us the DPO diagram.
        All that remains is to check that the aforementioned pushouts are traced
        boundary complements: this follows by inspecting components.

        Now the \(\ifdir\) direction: assume we have a DPO diagram (\ref{gath:dpo})
        where \(L \leftarrow i + j\), \(i + j \rightarrow R\), \(m + n \to G\) and
        \(m + n \to H\) are defined as in (\ref{gath:l-cospan}-\ref{gath:h-cospan})
        above.
        We must show that \(
            \iltikzfig{strings/category/f}[f][white]
            =
            \iltikzfig{strings/rewriting/rewrite-l}
        \) and \(
            \iltikzfig{strings/category/f}[H][white]
            =
            \iltikzfig{strings/rewriting/rewrite-r}
        \).
        By definition of traced boundary complement \(\cospan{j+m}{C}{i+n}\) is a
        partial monogamous cospan, so by fullness of \(\termandfrobtohypsigma\),
        there exists a term \(
            \iltikzfig{strings/category/f-2-2}[c][white][j][m][i][n]
            \in \stmcsigma
        \) such that \(
            \iltikzfig{strings/category/f-2-2}[c][white]
            =
            \cospan{j+m}{C}{i+n}
        \).
        By traced decomposition (\cref{lem:traced-decomposition}), we have that for any
        traced boundary complement \(\cospan{i+j}{C}{m+n}\) and morphism
        \(L \to G\), \(\cospan{m}{G}{n}\) can be factored as in
        (\ref{gath:decomposition}), i.e.\ \[
            \termandfrobtohypsigma[\iltikzfig{strings/category/f}[f][white]]
            =
            \trace{j}{\termandfrobtohypsigma[\iltikzfig{strings/category/f}[l][white]]
            \tensor
            \id[n]
            \seq
            \termandfrobtohypsigma[\iltikzfig{strings/category/f-2-2}[c][white]]}.
        \]
        So by functoriality, we have that \(
            \iltikzfig{strings/category/f}[f][white]
            =
            \iltikzfig{strings/rewriting/rewrite-l}
        \).
        The same reasoning follows for \(
            \iltikzfig{strings/category/f}[H][white]
            =
            \iltikzfig{strings/rewriting/rewrite-r}
        \).
    \end{proof}
% }{}

\subsection{Rewriting with traced comonoid structure}

To extend rewriting with traced structure to the comonoid case, the traced
boundary complement conditions need to be weakened to the case of
\emph{left}-monogamous cospans.

\begin{definition}[Traced left-boundary complement]
    \label{def:traced-left-boundary-complement}
    For partial left-monogamous cospans \(
        \cospan{i}[a_1]{L}[a_2]{j}
    \) and \(
        \cospan{n}[b_1]{G}[b_2]{m} \in \mathcal{C}
    \), a pushout complement as in \cref{def:traced-boundary-complement}
    is called a \emph{traced left-boundary complement} if \(c_2\)
    is mono and \(
        \cospan{j+m}[[c_2,d_1]]{\pushoutcomplement{L}}[[d_2,c_1]]{{n+i}}
    \) is a partial left-monogamous cospan.
\end{definition}

\begin{definition}[Traced comonoid DPO]
    For morphisms \(G \leftarrow m+n\) and \(H \leftarrow m+n\) in
    \(\hypsigma\), there is a traced comonoid rewrite \(G \trgrewrite[\mcr] H\)
    if there exists a rule \(
        \spann{L}{i+j}{G} \in \mcr
    \) and cospan \(
        \cospan{i+j}{C}{n+m} \in \hypsigma
    \) such that diagram in \cref{def:dpo} commutes, \(i+j \to C\) is a traced
    left-boundary complement and \(\morph{f}{L}{G}\) is an offcut matching.
\end{definition}

\begin{lemma}[Traced comonoid decomposition]\label{lem:traced-comonoid-decomposition}
    \cref{lem:traced-decomposition} holds when all cospans are partial
    left-monogamous and \(C\) is a traced left-boundary complement.
\end{lemma}
\iftoggle{proofs}{
    \begin{proof}

    \end{proof}
}{}

\begin{theorem}\label{thm:traced-comonoid-rewriting}
    Let \(\mcr\) be a rewriting system on \(\stmcsigma + \ccomon\).
    Then, \(
        \iltikzfig{strings/category/f}[g][white]
        \rewrite[\mcr]
        \iltikzfig{strings/category/f}[H][white]
    \) in \(\stmcsigma + \ccomon\) if and only if \(
        \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[g][white]]]
        \grewrite[\termandfrobtohypsigma[\foldinterfaces[\mcr]]]
        \termandfrobtohypsigma[\foldinterfaces[\iltikzfig{strings/category/f}[H][white]]].
    \)
\end{theorem}
\begin{proof}
    This is the same as for \cref{thm:traced-rewriting} but with the replacement
    of all traced boundary complements with traced left-boundary complements.
\end{proof}

\begin{example}
    As with the traced case, there may be multiple valid rewrites given a
    particular offcut matching and interface.
    The comonoid structure adds more possibilities, as there are the equations
    of commutative comonoids to consider.
    Consider the following rule and its interpretation.
    \begin{gather}
        \rrule{
            \iltikzfig{graphs/dpo/non-unique-comonoid/rule-lhs}
        }{
            \iltikzfig{graphs/dpo/non-unique-comonoid/rule-rhs}
        }
        \qquad
        \raisebox{-1.7em}{\includestandalone{figures/graphs/dpo/non-unique-comonoid/rule}}
        \label{gath:non-unique-rule-comonoid}
    \end{gather}
    Two valid rewrites are as follows:
    \begin{center}
        \includestandalone{figures/graphs/dpo/non-unique-comonoid/rewrite-1}
        \quad
        \includestandalone{figures/graphs/dpo/non-unique-comonoid/rewrite-2}
    \end{center}
    The first rewrite is the `obvious' one, but the second also holds by
    cocommutativity:
    \begin{gather*}
        \iltikzfig{graphs/dpo/non-unique-comonoid/rewrite-1}
        =
        \iltikzfig{graphs/dpo/non-unique-comonoid/rewrite-2a}
        \qquad
        \iltikzfig{graphs/dpo/non-unique-comonoid/rewrite-1}
        =
        \iltikzfig{graphs/dpo/non-unique-comonoid/rewrite-2b}
        =
        \iltikzfig{graphs/dpo/non-unique-comonoid/rewrite-3b}
    \end{gather*}
\end{example}